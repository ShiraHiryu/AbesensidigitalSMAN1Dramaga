<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Absensi Digital - SMAN 1 Dramaga</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .form-select, .form-input, .form-textarea { transition: all 0.3s ease; }
        .role-card { transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out; }
        .role-card:hover { transform: translateY(-5px); box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1); }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        #image-modal, #edit-modal { transition: opacity 0.3s ease; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 flex items-center justify-center min-h-screen">

    <div id="app" class="container mx-auto p-4 md:p-6 max-w-4xl w-full">

        <!-- ===== 1. HALAMAN PEMILIHAN PERAN (TAMPILAN AWAL) ===== -->
        <div id="role-selection-view" class="main-view">
            <div class="bg-white p-8 rounded-xl shadow-lg text-center">
                <img src="https://placehold.co/120x120/3B82F6/FFFFFF?text=SMAN+1" alt="Logo Sekolah" class="mx-auto mb-5 rounded-full">
                <h1 class="text-2xl md:text-3xl font-bold text-gray-800">Selamat Datang!</h1>
                <p class="text-gray-500 mt-2 mb-8">Silakan pilih peran Anda untuk melanjutkan.</p>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <button data-role="student" class="role-card bg-sky-50 p-6 rounded-lg border border-sky-200 text-sky-800"><svg class="w-12 h-12 mx-auto mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 14l9-5-9-5-9 5 9 5z"></path><path stroke-linecap="round" stroke-linejoin="round" d="M12 14l6.16-3.422a12.083 12.083 0 01.665 6.479A11.952 11.952 0 0012 20.055a11.952 11.952 0 00-6.824-2.998 12.078 12.078 0 01.665-6.479L12 14z"></path><path stroke-linecap="round" stroke-linejoin="round" d="M12 14l9-5-9-5-9 5 9 5zm0 0v6.055"></path></svg><span class="font-semibold text-lg">Saya Siswa</span></button>
                    <button data-role="teacher" class="role-card bg-emerald-50 p-6 rounded-lg border border-emerald-200 text-emerald-800"><svg class="w-12 h-12 mx-auto mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg><span class="font-semibold text-lg">Saya Guru</span></button>
                    <button data-role="admin" class="role-card bg-indigo-50 p-6 rounded-lg border border-indigo-200 text-indigo-800"><svg class="w-12 h-12 mx-auto mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path></svg><span class="font-semibold text-lg">Saya Admin</span></button>
                </div>
            </div>
        </div>
        
        <button class="back-to-role-select-btn flex items-center text-gray-600 hover:text-gray-900 font-semibold mb-4 hidden"><svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>Kembali</button>

        <!-- HALAMAN-HALAMAN LAIN -->
        <div id="student-attendance-view" class="main-view hidden"><div class="bg-white p-8 rounded-xl shadow-lg"><h1 class="text-2xl font-bold text-center mb-6">Form Absensi Siswa</h1><form id="student-attendance-form" class="space-y-6"></form></div></div>
        <div id="teacher-attendance-view" class="main-view hidden"><div class="bg-white p-8 rounded-xl shadow-lg"><h1 class="text-2xl font-bold text-center mb-6">Form Absensi Guru</h1><form id="teacher-attendance-form" class="space-y-6"></form></div></div>
        <div id="admin-login-view" class="main-view hidden"><div class="bg-white p-8 rounded-xl shadow-lg"><h1 class="text-2xl font-bold text-center mb-1">Login Admin</h1><p class="text-gray-500 text-center mb-6">Masukkan password.</p><form id="login-form" class="space-y-4"><div><label for="password" class="block text-sm font-medium text-gray-600">Password</label><input type="password" id="password" class="form-input mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500"></div><button type="submit" class="w-full bg-indigo-600 text-white py-3 px-4 rounded-md hover:bg-indigo-700 font-semibold shadow-md">Login</button><p id="login-error" class="text-red-500 text-sm mt-2 text-center hidden">Password salah.</p></form></div></div>

        <!-- ===== 5. DASHBOARD ADMIN (DIPERBARUI) ===== -->
        <div id="admin-view" class="main-view hidden">
             <div class="bg-white p-6 md:p-8 rounded-xl shadow-lg">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 border-b pb-4">
                    <div><h1 class="text-2xl md:text-3xl font-bold text-gray-800">Dashboard Admin</h1><p class="text-gray-500">Selamat Datang!</p></div>
                    <button id="logout-btn" class="mt-4 md:mt-0 w-full md:w-auto bg-red-600 text-white py-2 px-6 rounded-md hover:bg-red-700 font-semibold">Logout</button>
                </div>
                 <div class="mb-6 border-b border-gray-200">
                    <nav class="-mb-px flex space-x-6 overflow-x-auto" aria-label="Tabs"><button data-tab="absensi-siswa" class="admin-tab-btn whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-indigo-600 border-indigo-500">Rekap Siswa</button><button data-tab="absensi-guru" class="admin-tab-btn whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300 border-transparent">Rekap Guru</button><button data-tab="kelola-siswa" class="admin-tab-btn whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300 border-transparent">Kelola Siswa</button><button data-tab="kelola-guru" class="admin-tab-btn whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300 border-transparent">Kelola Guru</button></nav>
                </div>
                <div data-content="absensi-siswa" class="admin-tab-content"><h2 class="text-xl font-semibold mb-4 text-gray-700">Rekapitulasi Absensi Siswa</h2><div class="overflow-x-auto"><table class="min-w-full bg-white border border-gray-200"><thead><tr><th class="p-3 text-left text-xs font-semibold text-gray-600 uppercase">Nama</th><th class="p-3 text-left text-xs font-semibold text-gray-600 uppercase">Kelas</th><th class="p-3 text-left text-xs font-semibold text-gray-600 uppercase">Status</th><th class="p-3 text-left text-xs font-semibold text-gray-600 uppercase">Alasan</th><th class="p-3 text-left text-xs font-semibold text-gray-600 uppercase">Bukti</th><th class="p-3 text-left text-xs font-semibold text-gray-600 uppercase">Waktu</th></tr></thead><tbody id="student-attendance-table-body" class="divide-y divide-gray-200"></tbody></table></div></div>
                <div data-content="absensi-guru" class="admin-tab-content hidden"><h2 class="text-xl font-semibold mb-4 text-gray-700">Rekapitulasi Absensi Guru</h2><div class="overflow-x-auto"><table class="min-w-full bg-white border border-gray-200"><thead><tr><th class="p-3 text-left text-xs font-semibold text-gray-600 uppercase">Nama Guru</th><th class="p-3 text-left text-xs font-semibold text-gray-600 uppercase">Status</th><th class="p-3 text-left text-xs font-semibold text-gray-600 uppercase">Alasan</th><th class="p-3 text-left text-xs font-semibold text-gray-600 uppercase">Waktu</th></tr></thead><tbody id="teacher-attendance-table-body" class="divide-y divide-gray-200"></tbody></table></div></div>
                <div data-content="kelola-siswa" class="admin-tab-content hidden"><h2 class="text-xl font-semibold mb-4 text-gray-700">Kelola Data Siswa</h2><div class="overflow-x-auto"><table class="min-w-full bg-white border border-gray-200"><thead><tr><th class="p-3 text-left text-xs font-semibold text-gray-600 uppercase">Nama Siswa</th><th class="p-3 text-left text-xs font-semibold text-gray-600 uppercase">Kelas</th><th class="p-3 text-left text-xs font-semibold text-gray-600 uppercase">Aksi</th></tr></thead><tbody id="student-manage-table-body" class="divide-y divide-gray-200"></tbody></table></div></div>
                <div data-content="kelola-guru" class="admin-tab-content hidden"><h2 class="text-xl font-semibold mb-4 text-gray-700">Kelola Data Guru</h2><div class="overflow-x-auto"><table class="min-w-full bg-white border border-gray-200"><thead><tr><th class="p-3 text-left text-xs font-semibold text-gray-600 uppercase">Nama Guru</th><th class="p-3 text-left text-xs font-semibold text-gray-600 uppercase">Aksi</th></tr></thead><tbody id="teacher-manage-table-body" class="divide-y divide-gray-200"></tbody></table></div></div>
            </div>
        </div>
    </div>

    <!-- MODAL GAMBAR & EDIT -->
    <div id="image-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50 hidden opacity-0" onclick="hideImageModal()"><img id="modal-image" src="" class="max-w-full max-h-full rounded-lg shadow-lg" alt="Bukti Kehadiran"></div>
    <div id="edit-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50 hidden opacity-0">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md" onclick="event.stopPropagation()">
            <h2 id="edit-modal-title" class="text-xl font-bold mb-4">Ubah Data</h2>
            <form id="edit-form" class="space-y-4"></form>
        </div>
    </div>

    <script>
        function showImageModal(src){const m=document.getElementById('image-modal'),i=document.getElementById('modal-image');i.src=src;m.classList.remove('hidden');setTimeout(()=>m.classList.remove('opacity-0'),10)}
        function hideImageModal(){const m=document.getElementById('image-modal');m.classList.add('opacity-0');setTimeout(()=>m.classList.add('hidden'),300)}

        document.addEventListener('DOMContentLoaded', () => {
            const db={students:{},teachers:[],studentAttendanceRecords:[],teacherAttendanceRecords:[]};
            const fN=["Budi","Siti","Agus","Dewi","Eko","Fitri","Gilang","Hana","Indra","Jihan"],lN=["Santoso","Wijaya","Pratama","Lestari","Nugroho"];
            const gN=()=>`${fN[Math.floor(Math.random()*fN.length)]} ${lN[Math.floor(Math.random()*lN.length)]}`;
            [10,11,12].forEach(g=>['A','B','C'].forEach(c=>{const n=`${g} ${c}`;db.students[n]=Array.from({length:40},(_,i)=>({id:`${g}${c.replace(' ','')}-${i+1}`,name:gN()}))}));
            db.teachers=Array.from({length:20},(_,i)=>({id:`G-${i+1}`,name:`${["Drs.","Dra.","S.Pd.","M.Pd."][Math.floor(Math.random()*4)]} ${gN()}`}));

            const allViews=document.querySelectorAll('.main-view'),roleButtons=document.querySelectorAll('.role-card'),backButton=document.querySelector('.back-to-role-select-btn'),sForm=document.getElementById('student-attendance-form'),tForm=document.getElementById('teacher-attendance-form'),lForm=document.getElementById('login-form'),sTable=document.getElementById('student-attendance-table-body'),tTable=document.getElementById('teacher-attendance-table-body'),sManageTable=document.getElementById('student-manage-table-body'),tManageTable=document.getElementById('teacher-manage-table-body'),adminTabs=document.querySelectorAll('.admin-tab-btn'),adminContents=document.querySelectorAll('.admin-tab-content'),logoutBtn=document.getElementById('logout-btn'),editModal=document.getElementById('edit-modal'),editModalTitle=document.getElementById('edit-modal-title'),editForm=document.getElementById('edit-form');
            
            const showView=id=>{allViews.forEach(v=>v.classList.add('hidden'));const t=document.getElementById(id);if(t){t.classList.remove('hidden');backButton.classList.toggle('hidden',id==='role-selection-view'||id==='admin-view')}};
            const sFormHTML=`<div><label for="class-select" class="block text-sm font-medium text-gray-600 mb-1">Pilih Kelas</label><select id="class-select" class="form-select block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500"><option value="">-- Pilih Kelas Dahulu --</option></select></div><div><label for="student-select" class="block text-sm font-medium text-gray-600 mb-1">Pilih Nama</label><select id="student-select" class="form-select block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" disabled><option value="">-- Nama Siswa --</option></select></div>${sharedFields('student')}<div><label for="student-proof-photo" class="block text-sm font-medium text-gray-600 mb-1">Unggah Bukti Foto <span class="text-gray-400">(Wajib Izin/Sakit)</span></label><input type="file" id="student-proof-photo" accept="image/*" class="form-input block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-violet-50 file:text-violet-700 hover:file:bg-violet-100 cursor-pointer"><img id="photo-preview" class="mt-4 rounded-md max-h-40 hidden" src="" alt="Pratinjau Foto"/></div><button type="submit" class="w-full bg-sky-600 text-white py-3 px-4 rounded-md hover:bg-sky-700 font-semibold shadow-md">Kirim Absensi</button><p id="student-success" class="text-green-600 text-center font-medium hidden mt-4">Absensi berhasil dicatat!</p>`;
            const tFormHTML=`<div><label for="teacher-select" class="block text-sm font-medium text-gray-600 mb-1">Pilih Nama</label><select id="teacher-select" class="form-select block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500"><option value="">-- Pilih Nama Anda --</option></select></div>${sharedFields('teacher')}<button type="submit" class="w-full bg-emerald-600 text-white py-3 px-4 rounded-md hover:bg-emerald-700 font-semibold shadow-md">Kirim Absensi</button><p id="teacher-success" class="text-green-600 text-center font-medium hidden mt-4">Absensi berhasil dicatat!</p>`;
            function sharedFields(t){return`<div><label class="block text-sm font-medium text-gray-600 mb-1">Hari</label><select id="${t}-day-select" class="form-select block w-full rounded-md border-gray-300 shadow-sm"><option>Senin</option><option>Selasa</option><option>Rabu</option><option>Kamis</option><option>Jumat</option></select></div><div><label class="block text-sm font-medium text-gray-600 mb-2">Status</label><div class="grid grid-cols-2 md:grid-cols-4 gap-4">${['Hadir','Izin','Sakit','Terlambat'].map(s=>`<label class="flex items-center p-3 border rounded-md cursor-pointer hover:bg-gray-50"><input type="radio" name="${t}-status" value="${s}" class="form-radio h-5 w-5 text-indigo-600" ${s==='Hadir'?'checked':''}> <span class="ml-3 font-medium">${s}</span></label>`).join('')}</div></div><div id="${t}-reason-container" class="hidden"><label for="${t}-reason" class="block text-sm font-medium text-gray-600 mb-1">Alasan</label><textarea id="${t}-reason" rows="3" class="form-textarea block w-full rounded-md border-gray-300 shadow-sm" placeholder="Tuliskan alasan..."></textarea></div>`}
            const setupStatusListener=t=>document.querySelectorAll(`input[name="${t}-status"]`).forEach(r=>r.addEventListener('change',e=>{const c=document.getElementById(`${t}-reason-container`);c.classList.toggle('hidden',!['Izin','Sakit','Terlambat'].includes(e.target.value));if(c.classList.contains('hidden'))document.getElementById(`${t}-reason`).value='';}));
            const renderTable=(tbody,data,template,emptyMsg)=>{tbody.innerHTML=data.length===0?`<tr><td colspan="7" class="text-center py-10 text-gray-500">${emptyMsg}</td></tr>`:data.map(template).join('')};
            const sRow=r=>{const c={'Hadir':'bg-green-100 text-green-800','Izin':'bg-blue-100 text-blue-800','Sakit':'bg-yellow-100 text-yellow-800','Terlambat':'bg-red-100 text-red-800'},p=r.photoProof?`<img src="${r.photoProof}" class="h-10 w-10 object-cover rounded cursor-pointer" onclick="showImageModal('${r.photoProof}')">`:`<span class="text-xs text-gray-400">N/A</span>`;return`<tr><td class="p-3">${r.studentName}</td><td class="p-3">${r.className}</td><td class="p-3"><span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${c[r.status]}">${r.status}</span></td><td class="p-3">${r.reason||'-'}</td><td class="p-3">${p}</td><td class="p-3 text-sm text-gray-500">${r.timestamp}</td></tr>`};
            const tRow=r=>{const c={'Hadir':'bg-green-100 text-green-800','Izin':'bg-blue-100 text-blue-800','Sakit':'bg-yellow-100 text-yellow-800','Terlambat':'bg-red-100 text-red-800'};return`<tr><td class="p-3">${r.teacherName}</td><td class="p-3"><span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${c[r.status]}">${r.status}</span></td><td class="p-3">${r.reason||'-'}</td><td class="p-3 text-sm text-gray-500">${r.timestamp}</td></tr>`};
            
            const renderStudentManagement=()=>{let rows='';Object.keys(db.students).sort().forEach(cl=>{db.students[cl].forEach(st=>{rows+=`<tr><td class="p-3">${st.name}</td><td class="p-3">${cl}</td><td class="p-3"><button class="edit-student-btn bg-yellow-500 text-white text-xs font-bold py-1 px-3 rounded hover:bg-yellow-600" data-id="${st.id}" data-class="${cl}">Ubah</button></td></tr>`})});sManageTable.innerHTML=rows};
            const renderTeacherManagement=()=>{tManageTable.innerHTML=db.teachers.map(t=>`<tr><td class="p-3">${t.name}</td><td class="p-3"><button class="edit-teacher-btn bg-yellow-500 text-white text-xs font-bold py-1 px-3 rounded hover:bg-yellow-600" data-id="${t.id}">Ubah</button></td></tr>`).join('')};
            
            function showEditModal(type,id,currentClass){
                let item, title, formHTML;
                if(type==='student'){
                    item=db.students[currentClass].find(s=>s.id===id);
                    title=`Ubah Data Siswa: ${item.name}`;
                    const classOptions=Object.keys(db.students).sort().map(c=>`<option value="${c}" ${c===currentClass?'selected':''}>${c}</option>`).join('');
                    formHTML=`<div><label class="block text-sm font-medium">Nama Siswa</label><input type="text" id="edit-name" value="${item.name}" class="form-input mt-1 block w-full rounded-md border-gray-300"></div><div><label class="block text-sm font-medium">Kelas</label><select id="edit-class" class="form-select mt-1 block w-full rounded-md border-gray-300">${classOptions}</select></div>`;
                } else {
                    item=db.teachers.find(t=>t.id===id);
                    title=`Ubah Data Guru: ${item.name}`;
                    formHTML=`<div><label class="block text-sm font-medium">Nama Guru</label><input type="text" id="edit-name" value="${item.name}" class="form-input mt-1 block w-full rounded-md border-gray-300"></div>`;
                }
                editForm.innerHTML = formHTML + `<div class="flex justify-end gap-3 mt-6"><button type="button" id="cancel-edit" class="bg-gray-200 text-gray-800 py-2 px-4 rounded-md hover:bg-gray-300">Batal</button><button type="submit" class="bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700">Simpan</button></div>`;
                editModalTitle.textContent=title;
                editModal.classList.remove('hidden');setTimeout(()=>editModal.classList.remove('opacity-0'),10);
                document.getElementById('cancel-edit').onclick=()=>hideEditModal();
                editForm.onsubmit=e=>{e.preventDefault();saveChanges(type,id,currentClass)};
            }
            function hideEditModal(){editModal.classList.add('opacity-0');setTimeout(()=>editModal.classList.add('hidden'),300)}
            
            function saveChanges(type,id,oldClass){
                const newName=document.getElementById('edit-name').value;
                if(!newName.trim()){alert('Nama tidak boleh kosong.');return}
                if(type==='student'){
                    const newClass=document.getElementById('edit-class').value;
                    const studentIndex=db.students[oldClass].findIndex(s=>s.id===id);
                    const [student]=db.students[oldClass].splice(studentIndex,1);
                    student.name=newName;db.students[newClass].push(student);db.students[newClass].sort((a,b)=>a.name.localeCompare(b.name));
                    if(db.students[oldClass].length===0)delete db.students[oldClass];
                }else{const teacher=db.teachers.find(t=>t.id===id);teacher.name=newName}
                hideEditModal();refreshAllData();
            }
            
            function refreshAllData(){renderStudentManagement();renderTeacherManagement();initStudentForm();initTeacherForm()}
            
            roleButtons.forEach(btn=>btn.addEventListener('click',()=>showView({'student':'student-attendance-view','teacher':'teacher-attendance-view','admin':'admin-login-view'}[btn.dataset.role])));
            backButton.addEventListener('click',()=>showView('role-selection-view'));
            
            sForm.addEventListener('submit',async e=>{
                e.preventDefault();
                const cS=document.getElementById('class-select'),sS=document.getElementById('student-select');
                let status=document.querySelector('input[name="student-status"]:checked').value;
                const fI=document.getElementById('student-proof-photo'),f=fI.files[0];
                if(!cS.value||!sS.value){alert('Pilih kelas dan nama.');return}
                
                // ::: LOGIKA WAKTU OTOMATIS :::
                const now = new Date();
                const deadline = new Date(now);
                deadline.setHours(7, 0, 0, 0); // Batas waktu jam 7:00:00 pagi

                if (now > deadline && status === 'Hadir') {
                    status = 'Terlambat';
                    // Otomatis tandai radio button terlambat dan tampilkan alasan
                    document.querySelector('input[name="student-status"][value="Terlambat"]').checked = true;
                    document.getElementById('student-reason-container').classList.remove('hidden');
                    alert('Anda tercatat TERLAMBAT karena absen setelah jam 7 pagi.');
                }
                // ::::::::::::::::::::::::::::::

                if((status==='Izin'||status==='Sakit')&&!f){alert('Bukti foto wajib untuk Izin/Sakit.');return}
                
                let pDU=null;if(f){pDU=await new Promise(r=>{const rd=new FileReader();rd.onload=ev=>r(ev.target.result);rd.readAsDataURL(f)})}
                db.studentAttendanceRecords.unshift({className:cS.value,studentName:sS.value,day:document.getElementById('student-day-select').value,status:status,reason:document.getElementById('student-reason').value,photoProof:pDU,timestamp:now.toLocaleTimeString('id-ID',{hour:'2-digit',minute:'2-digit'})});
                document.getElementById('student-success').classList.remove('hidden');setTimeout(()=>document.getElementById('student-success').classList.add('hidden'),3000);e.target.reset();sS.innerHTML='<option value="">-- Nama Siswa --</option>';sS.disabled=true;document.getElementById('student-reason-container').classList.add('hidden');const p=document.getElementById('photo-preview');p.src='';p.classList.add('hidden');renderTable(sTable,db.studentAttendanceRecords,sRow,"Belum ada absensi siswa.")});
            
            tForm.addEventListener('submit',e=>{
                e.preventDefault();
                const tS=document.getElementById('teacher-select');
                let status = document.querySelector('input[name="teacher-status"]:checked').value;
                if(!tS.value){alert('Pilih nama Anda.');return}

                // ::: LOGIKA WAKTU OTOMATIS UNTUK GURU :::
                const now = new Date();
                const deadline = new Date(now);
                deadline.setHours(7, 0, 0, 0);

                if (now > deadline && status === 'Hadir') {
                    status = 'Terlambat';
                    document.querySelector('input[name="teacher-status"][value="Terlambat"]').checked = true;
                    document.getElementById('teacher-reason-container').classList.remove('hidden');
                    alert('Anda tercatat TERLAMBAT karena absen setelah jam 7 pagi.');
                }
                // :::::::::::::::::::::::::::::::::::::::

                db.teacherAttendanceRecords.unshift({teacherName:tS.value,day:document.getElementById('teacher-day-select').value,status:status,reason:document.getElementById('teacher-reason').value,timestamp:now.toLocaleTimeString('id-ID',{hour:'2-digit',minute:'2-digit'})});
                document.getElementById('teacher-success').classList.remove('hidden');setTimeout(()=>document.getElementById('teacher-success').classList.add('hidden'),3000);e.target.reset();document.getElementById('teacher-reason-container').classList.add('hidden');renderTable(tTable,db.teacherAttendanceRecords,tRow,"Belum ada absensi guru.")});

            lForm.addEventListener('submit',e=>{e.preventDefault();const p=document.getElementById('password'),er=document.getElementById('login-error');if(p.value==='12345'){showView('admin-view');p.value='';er.classList.add('hidden');renderTable(sTable,db.studentAttendanceRecords,sRow,"Belum ada absensi siswa.");renderTable(tTable,db.teacherAttendanceRecords,tRow,"Belum ada absensi guru.");renderStudentManagement();renderTeacherManagement()}else{er.classList.remove('hidden')}});
            logoutBtn.addEventListener('click',()=>showView('role-selection-view'));
            adminTabs.forEach(t=>t.addEventListener('click',()=>{adminTabs.forEach(b=>b.className=b.className.replace('text-indigo-600 border-indigo-500','text-gray-500 border-transparent'));adminContents.forEach(c=>c.classList.add('hidden'));t.className=t.className.replace('text-gray-500 border-transparent','text-indigo-600 border-indigo-500');document.querySelector(`.admin-tab-content[data-content="${t.dataset.tab}"]`).classList.remove('hidden')}));
            
            sManageTable.addEventListener('click',e=>{if(e.target.classList.contains('edit-student-btn')){const{id,class:cl}=e.target.dataset;showEditModal('student',id,cl)}});
            tManageTable.addEventListener('click',e=>{if(e.target.classList.contains('edit-teacher-btn')){showEditModal('teacher',e.target.dataset.id)}});
            editModal.addEventListener('click',hideEditModal);

            function initStudentForm(){sForm.innerHTML=sFormHTML;setupStatusListener('student');const cS=document.getElementById('class-select');cS.innerHTML='<option value="">-- Pilih Kelas Dahulu --</option>';Object.keys(db.students).sort().forEach(c=>cS.innerHTML+=`<option value="${c}">${c}</option>`);cS.addEventListener('change',e=>{const sS=document.getElementById('student-select');sS.innerHTML='<option value="">-- Pilih Nama --</option>';if(e.target.value){db.students[e.target.value].forEach(s=>sS.innerHTML+=`<option value="${s.name}">${s.name}</option>`);sS.disabled=false}else{sS.disabled=true}});const pI=document.getElementById('student-proof-photo'),pV=document.getElementById('photo-preview');pI.addEventListener('change',()=>{const f=pI.files[0];if(f){const r=new FileReader();r.onload=ev=>{pV.src=ev.target.result;pV.classList.remove('hidden')};r.readAsDataURL(f)}else{pV.src='';pV.classList.add('hidden')}})}
            function initTeacherForm(){tForm.innerHTML=tFormHTML;setupStatusListener('teacher');const tS=document.getElementById('teacher-select');tS.innerHTML='<option value="">-- Pilih Nama Anda --</option>';db.teachers.forEach(t=>tS.innerHTML+=`<option value="${t.name}">${t.name}</option>`)}
            
            initStudentForm();initTeacherForm();
        });
    </script>
</body>
</html>
